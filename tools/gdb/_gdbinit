add-auto-load-safe-path ~/
define riscv64-setup
target remote localhost:1234
symbol-file kernel-dbg.elf
end

define load_symbol
file kernel-dbg.elf
symbol-file kernel-dbg.elf
end

define six
si
x /i $pc
end

#
#赤黒木操作
#
# rbtree_left rbtreeの要素 rbtreeのエントリ名
# rbtreeの左の要素を得る
# $rbtree_left_retvalに対象の構造体へのアドレスが得られる
define rbtree_rb_left
  set $rbtree_rb_left_retval = ($arg0)->$arg1.rbe_left
end
# rbtree_right rbtreeの要素 rbtreeのエントリ名
# rbtreeの右の要素を得る
# $rbtree_right_retvalに対象の構造体へのアドレスが得られる
define rbtree_rb_right
  set $rbtree_rb_right_retval = ($arg0)->$arg1.rbe_right
end
# rbtree_parent rbtreeの要素 rbtreeのエントリ名
# rbtreeの親の要素を得る
# $rbtree_parent_retvalに対象の構造体へのアドレスが得られる
define rbtree_rb_parent
  set $rbtree_rb_parent_retval = ($arg0)->$arg1.rbe_parent
end
# rbtree_minmax ヘッド名 rbtreeのエントリ名 -1または1
# rbtreeの最小ノード, 最大ノードを得る
# 第3引数に-1を指定するとMIN, 1を指定するとMAXが得られる
# $rbtree_minmax_retvalに対象の構造体へのアドレスが得られる
# 使用例:
# (gdb) rbtree_minmax &g_thrdb.head ent -1
# (gdb) p $rbtree_minmax_retval
# $1 = (struct _thread *) 0x7fffecf73cf8
define rbtree_minmax
  set $tmp_rb_minmax = ($arg0)->rbh_root
  set $val = $arg2
  while $tmp_rb_minmax != NULL
    set $parent = $tmp_rb_minmax
    if $val < 0
      rbtree_rb_left $tmp_rb_minmax $arg1
      set $tmp_rb_minmax = $rbtree_rb_left_retval
    else
      rbtree_rb_right $tmp_rb_minmax $arg1
      set $tmp_rb_minmax = $rbtree_rb_right_retval
    end
    set $rbtree_minmax_retval = $parent
end

# rbtree_next rbtreeの要素 rbtreeのエントリ名
# rbtreeの次の要素を得る
# $rbtree_next $ent
# 使用例:
# (gdb) rbtree_minmax &g_thrdb.head ent -1
# (gdb) p $rbtree_minmax_retval
# $1 = (struct _thread *) 0x7fffecf73cf8
# (gdb) rbtree_next $rbtree_minmax_retval ent
# (gdb) p $rbtree_next_retval
# $2 = (struct _thread *) 0x7fffecf73ad0
define rbtree_next
  set $tmp_rbtree_next = $arg0
  rbtree_rb_right $tmp_rbtree_next $arg1
  if $rbtree_rb_right_retval != NULL
    rbtree_rb_right $tmp_rbtree_next $arg1
    set $tmp_rbtree_next = $rbtree_rb_right_retval
    rbtree_rb_left $tmp_rbtree_next $arg1
    while $rbtree_rb_left_retval != NULL
      rbtree_rb_left $tmp_rbtree_next $arg1
      set $tmp_rbtree_next = $rbtree_rb_left_retval
    end
  else
    rbtree_rb_parent $tmp_rbtree_next $arg1
    set $tmp_rbtree_next2 = $rbtree_rb_parent_retval
    rbtree_rb_left $tmp_rbtree_next2 $arg1
    set $tmp_rbtree_next3 = $rbtree_rb_left_retval
    if ( ( $tmp_rbtree_next2 != NULL ) && ( $tmp_rbtree_next == $tmp_rbtree_next3 ) )
      rbtree_rb_parent $tmp_rbtree_next $arg1
      set $tmp_rbtree_next = $rbtree_rb_parent_retval
    else
      rbtree_rb_parent $tmp_rbtree_next $arg1
      set $tmp_rbtree_next2 = $rbtree_rb_parent_retval
      rbtree_rb_right $tmp_rbtree_next2 $arg1
      set $tmp_rbtree_next3 = $rbtree_rb_right_retval
      while ( ( $tmp_rbtree_next2 != NULL ) && ( $tmp_rbtree_next == $tmp_rbtree_next3 ) )
	rbtree_rb_parent $tmp_rbtree_next $arg1
	set $tmp_rbtree_next = $rbtree_rb_parent_retval
      end
      rbtree_rb_parent $tmp_rbtree_next $arg1
      set $tmp_rbtree_next = $rbtree_rb_parent_retval
    end
  end
  set $rbtree_next_retval = $tmp_rbtree_next
end


# rbtree_foreach ヘッド名 rbtreeのエントリ名
# rbtreeの要素をリストアップする
# rbtree_foreach
# 使用例: rbtree_foreach  &g_thrdb.head ent
# (gdb) rbtree_minmax &g_thrdb.head ent -1
# (gdb) p $rbtree_minmax_retval
# $1 = (struct _thread *) 0x7fffecf73cf8
# (gdb) rbtree_next $rbtree_minmax_retval ent
# (gdb) p $rbtree_next_retval
# $2 = (struct _thread *) 0x7fffecf73ad0
define rbtree_foreach
  rbtree_minmax $arg0 $arg1 -1
  set $var = $rbtree_minmax_retval
  while ( $var != NULL )
    rbtree_next $var $arg1
    set $var = $rbtree_next_retval
  end
end
